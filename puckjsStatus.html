<!DOCTYPE html>
<html>
<head>
  <title>Puck.js Time & Storage Viewer</title>
  <meta charset="utf-8">
  <script src="https://www.puck-js.com/puck.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #005fa3;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    pre {
      background: #eee;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Puck.js Time & Storage Viewer</h1>
  <button onclick="connectPuck()">Connect to Puck.js</button>

  <div id="output">
    <h2>Current Time</h2>
    <p id="time">Not connected</p>

    <h2>Files in Storage</h2>
    <pre id="files">Not connected</pre>
  </div>

  <script>
    function getDate(conn) {
        conn.write("JSON.stringify(Date())\n", function(d) {
            try {
                console.log("SENT");
            } catch (e) {
                console.log("ERROR: " + e);
            }
        });
    }

    function getFiles(conn) {
        conn.write("JSON.stringify(require('Storage').list())\n", function(d) {
          try {
            console.log("SENT");
          } catch (e) {
            console.log("ERROR: " + e);
          }
        });
    }

    function processDate(d) {
        console.log("DATE DATA: " + d);
    }

    function processFiles(d) {
        console.log("FILE DATA: " + d);
    }

    function startCommands() {
        currentIdx = 0;
        buffer = "";
        functionList[currentIdx](puckConnection);
    }

    function receiveData(d) {
        console.log("IN DATA: " + d);
        let chunk = "";
        if (typeof d === 'string') chunk = d;
        else {
          try { chunk = new TextDecoder().decode(d); }
          catch (e) { chunk = String(d); }
        }

        buffer += chunk;
        if (chunk.indexOf(">") >= 0) {
            if(currentIdx < functionList.length) {
                processList[currentIdx](buffer);
                currentIdx += 1;
                console.log("INDEX: " + currentIdx + " : " + functionList.length);
                buffer = "";
                if(currentIdx < functionList.length) {
                    setTimeout(() => {console.log("INDEX: " + currentIdx); functionList[currentIdx](puckConnection);
                    }, 100);
                }
            }
        }
    }

    var processList = [processDate, processFiles];
    var functionList = [getDate, getFiles];
    var currentIdx = 0;
    var buffer = "";
    var puckConnection;

    function connectPuck() {
        Puck.debug = 3;
        currentIdx = 0;
        buffer = "";
        if(!puckConnection) {
        Puck.connect(function(connection) {
        if (!connection) {
          alert("Couldn't connect!");
          return;
        }
        else {
            puckConnection = connection;
        }
        // Handle data event
        puckConnection.on('data', receiveData);
        puckConnection.on('close', function() { console.log("CONNECTION CLOSE")});

        setTimeout(() => {if(puckConnection.isOpen) startCommands();},100);


   // if(puckConnection.isOpen) startCommands(puckConnection);



        //connection.write("JSON.stringify(Date())\n", function(d) {
          //try {
            //console.log("SENT");
          //} catch (e) {
            //console.log("ERROR: " + e);
          //}
        //});

        //List files in storage
        //connection.on('data', function(d) {
            //console.log("DATA: " + d)
            ////document.getElementById("files").innerText = files.join('\n');
        //});
        //connection.write("JSON.stringify(require('Storage').list())\n", function(d) {
          //try {
            //console.log("SENT");
          //} catch (e) {
            //console.log("ERROR: " + e);
          //}
        //});
      });
  }
  else {
    setTimeout(() => {if(puckConnection.isOpen) startCommands();},100);
  }

  }

  </script>
</body>
</html>
