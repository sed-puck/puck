<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Puck.js Storage Uploader (Web Bluetooth)</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
       /* align-items: center; */
       /* height: 100vh;*/
       padding: 30px;
        margin: 0;
    }
    .container {
        background: white;
        padding: 5px 20px 20px 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
        width: 300px;
    }
    h3 {
        margin-top: 8px;
        margin-bottom: 2px;
        font-weight: normal;
        font-size:14px;
    }
    .card {
        max-width:820px;
        margin:auto;padding:18px;
        border-radius:12px;
        box-shadow:0 6px 18px rgba(0,0,0,0.08)
    }
    input[type="file"], input[type="text"] {
        box-sizing: border-box;
        width: 100%;
        padding: 6px;
        margin-top: 4px;
        margin-bottom: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background:#F5F5F5;
    }
    button {
        padding: 10px;
        background: #007BFF;
        width: 100%;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 5px;
        font-size: 14px;
    }
    button:hover {
        background: #0056b3;
    }
    button:disabled,
        button[disabled]{
        border: none;
        background:#D3D3D3;
       /* background-color: #cccccc; */
        color: #666666;
    }
    progress {
        width:100%;
        height:18px
    }
    pre {
        background:#111;
        color:#eee;
        padding:12px;
        border-radius:8px;
        overflow:auto;
        max-height: 100px;
        text-align: left;
    }
    label {
        display:block;
        margin-top: 8px;
        margin-bottom: 4px;
        font-size: 14px;
    }
    .button-row {
        text-align: right;
        margin-top: 20px;

    }
    button, .back-button {
        bottom: 15px;
        right: 20px;
        padding: 8px 16px;
        background: ;
        /*color: #fff;*/
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        transition: background 0.3s;
    }
    .back-button:hover {
        background: #0056b3;
    }
    .back-button {
        background-color: #007BFF;
        color: #fff;
    }
    .statusDiv {
        background:#F5F5F5;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-top:8px;
        margin-bottom:8px;
        font-size:14px;
        padding: 4px;
        color:#333";
    }

  </style>
</head>
<body>
  <div class="container">

    <h2>Blue Controller</h2>
    <h3>Upload a file to Puck.js</h3>
    <input id="file" type="file" />
    <label>Upload filename <input id="filename" type="text" placeholder="No name chosen" /></label>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button id="connectBtn">Connect to Puck.js</button>
      <button id="uploadBtn" disabled>Upload file to Storage</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <label>Progress:</label>
    <progress id="progress" value="0" max="100"></progress>
    <div id="status" class="statusDiv">Idle</div>
    <div class="button-row">
      <a href="javascript:window.history.back();" class="back-button">Back</a>
    </div>
    <h3>Console</h3>
    <pre id="log"  style="margin-top:3px"></pre>
  </div>

<script>
const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_TX_CHAR    = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX_CHAR    = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const progressEl = document.getElementById('progress');
const connectBtn = document.getElementById('connectBtn');
const uploadBtn = document.getElementById('uploadBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const fileInput = document.getElementById('file');
const filenameInput = document.getElementById('filename');
const CHUNKSIZE = 384;// or any multiple of 96 for atob/btoa
//const CHUNKSIZE = 288;// or any multiple of 96 for atob/btoa
const TX_CHUNKSIZE = 20;

let device, server, nusService, txChar, rxChar;

let sendSize = 0;
let sentBytes = 0;

function log(...args){
  console.log(...args);
  logEl.textContent += args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ') + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s){ statusEl.textContent = s; }

async function connect(){
  try{
    log('Requesting Bluetooth device...');
    device = await navigator.bluetooth.requestDevice({
      filters: [{namePrefix: 'Puck'}, {services: [NUS_SERVICE_UUID]}],
      optionalServices: [NUS_SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    log('Connecting to GATT...');
    server = await device.gatt.connect();
    log('Getting service...');
    nusService = await server.getPrimaryService(NUS_SERVICE_UUID);
    txChar = await nusService.getCharacteristic(NUS_TX_CHAR);
    try{ rxChar = await nusService.getCharacteristic(NUS_RX_CHAR); }
    catch(e){ rxChar = null; log('No RX characteristic (notifications) available.'); }

    if(rxChar){
//      await rxChar.startNotifications();
//      rxChar.addEventListener('characteristicvaluechanged', handleNotification);
    }

    setStatus('Connected to ' + (device.name || device.id));
    uploadBtn.disabled = false;
    disconnectBtn.disabled = false;
    connectBtn.disabled = true;
    log('Ready.');
  }catch(err){ log('Connection failed:', err); setStatus('Connection failed: ' + err); }
}

function onDisconnected(){
  log('Device disconnected');
  setStatus('Disconnected');
  uploadBtn.disabled = true;
  disconnectBtn.disabled = true;
  connectBtn.disabled = false;
}

async function disconnect(){ if(device && device.gatt.connected) await device.gatt.disconnect(); }

function handleNotification(e){
  const value = e.target.value;
  let str = '';
  try{
    for(let i=0;i<value.byteLength;i++){
      const b = value.getUint8(i);
      if(b>=32 && b<=126) str += String.fromCharCode(b); else str += '\\x' + b.toString(16).padStart(2,'0');
    }
  }catch(e){ str = '<unparseable>' }
  //log('RX:', str);
}

  function str2ab(str) {
    var buf = new ArrayBuffer(str.length);
    var bufView = new Uint8Array(buf);
    for (var i=0, strLen=str.length; i<strLen; i++) {
      bufView[i] = str.charCodeAt(i);
    }
    return buf;
  }

async function writeCommand(cmd){
  if(!txChar) throw new Error('No TX characteristic');
//  const data = new TextEncoder().encode(cmd + "\n");
//console.log("WRITE: " + data);
  await txChar.writeValue(cmd);

}

/*
   * Get the JS needed to upload a file
   * Splits an ArrayBuffer into chunks of Uint8Array and processes each chunk.
   * @param {string} fileName Path to file to upload
    *@param {ArrayBuffer} content -The input ArrayBuffer containing 8-bit values.
    * @param {number} chunkSize - The size of each chunk.
   * @returns {string} JS code needed to upload file
   */
  function processArrayBufferInChunks(fileName, contents, chuncksize) {
    var js = [];
    if (fileName.length==0 || fileName.length>28) {
      throw new Error("Invalid filename length");
    }
    if (!(contents instanceof ArrayBuffer)) {
      throw new TypeError("First argument must be an ArrayBuffer.");
    }
    if (typeof chuncksize !== "number" || chuncksize <= 0) {
      throw new RangeError("chuncksize must be a positive number.");
    }
    var fn = JSON.stringify(fileName);

    const view = new Uint8Array(contents);
    const totalLength = view.length;

    for (let i = 0; i < totalLength; i += chuncksize) {
      const chunk = view.subarray(i, i + chuncksize);
      let jsstr = `require("Storage").write(${fn},atob(${JSON.stringify(chunk.toBase64())}),${i}${(i==0)?"," + view.length:""})`
      //console.log("JSSTR: " + jsstr);
      js.push(jsstr + "\n");
    }
    return js
  }

/**
 * Splits an ArrayBuffer into chunks of a given size.
 *
 * @param {ArrayBuffer} buffer - The input ArrayBuffer.
 * @param {number} chunkSize - The maximum size (in bytes) of each chunk.
 * @returns {ArrayBuffer[]} An array of smaller ArrayBuffers.
 */
function chunkArrayBuffer(buffer, chunkSize) {
  if (!(buffer instanceof ArrayBuffer)) {
    throw new TypeError("Input must be an ArrayBuffer");
  }
  if (chunkSize <= 0) {
    throw new RangeError("chunkSize must be greater than 0");
  }

  const result = [];
  const totalSize = buffer.byteLength;

  for (let offset = 0; offset < totalSize; offset += chunkSize) {
    const end = Math.min(offset + chunkSize, totalSize);
    result.push(buffer.slice(offset, end));
  }

  return result;
}

function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function updateProgress(chunkLen) {
    sentBytes += chunkLen;
    progressEl.value = (sentBytes*100)/sendSize;
}


async function sendCommandChunked(cmd) {
    let cmdbuf = str2ab(cmd);
    let  chunks = chunkArrayBuffer(cmdbuf,TX_CHUNKSIZE);
    for( i=0; i < chunks.length; i++) {
        let b = new Uint8Array(chunks[i]);

        await writeCommand(b);
        wait(100).then(() => { updateProgress(TX_CHUNKSIZE); });
    }
}

async function upload(){
  if(!txChar){ alert('No connection'); return; }
  const file = fileInput.files[0];
  if(!file){ alert('Select a file first'); return; }
  if(!filenameInput.value.trim()){
    filenameInput.value = file.name; // default to selected filename
  }
  const filename = filenameInput.value.trim();

  setStatus('Reading file...');
  const buf = await file.arrayBuffer();
  let js = processArrayBufferInChunks(filename, buf, CHUNKSIZE); //.replace(/\n/g,"\n\x10");

  // Calculate number of bytes to send
  progressEl.value = 0;
  for(let i=0;i<js.length;i++) {
      sendSize += js[i].length;
  }
  //console.log("DATA SIZE: " + sendSize);

  setStatus('Uploading file');

  for(let i=0;i<js.length;i++){
    const cmd = js[i];
//    console.log("JSCMD: " + js.length + " : " + cmd);
    await sendCommandChunked(cmd);
    wait(100).then(() => { updateProgress(TX_CHUNKSIZE); });
  }

  setStatus('Upload complete');
  log('Upload finished. Sent', sendSize, 'bytes\nFile size:', buf.byteLength, 'bytes');
}

connectBtn.addEventListener('click', connect);
uploadBtn.addEventListener('click', upload);
disconnectBtn.addEventListener('click', disconnect);

fileInput.addEventListener('change', ()=>{
  if(fileInput.files.length){
    filenameInput.value = fileInput.files[0].name;
  }
});

if(!navigator.bluetooth){
  setStatus('Web Bluetooth API not available in this browser. Use Chrome/Edge on Desktop or Android.');
}
</script>
</body>
</html>
