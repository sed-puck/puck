<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Puck.js Storage Uploader (Web Bluetooth)</title>
  <style>
    body {
        font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
        margin:24px
    }
    .container {
        background: white;
        padding: 5px 20px 20px 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
        width: 300px;
    }
    .card {
        max-width:820px;
        margin:auto;padding:18px;
        border-radius:12px;
        box-shadow:0 6px 18px rgba(0,0,0,0.08)
    }
    input[type="file"], input[type="text"] {
        box-sizing: border-box;
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    button {
        padding: 10px;
        background: #007BFF;
        width: 100%;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 5px;
        font-size: 14px;
    }
    button:hover {
        background: #0056b3;
    }
    progress {
        width:100%;
        height:18px
    }
    pre {
        background:#111;
        color:#eee;
        padding:12px;
        border-radius:8px;
        overflow:auto;
        max-height: 250px;
        text-align: left;
    }
    label {
        display:block;
        margin-top:10px
    }
    .button-row {
        text-align: right;
        margin-top: 20px;
    }
    button, .back-button {
        bottom: 15px;
        right: 20px;
        padding: 8px 16px;
        background: ;
        /*color: #fff;*/
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        transition: background 0.3s;
    }
    .back-button:hover {
        background: #0056b3;
    }
    .back-button {
        background-color: #007BFF;
        color: #fff;
    }

  </style>
</head>
<body>
  <div class="container">

    <h1>File Uploader</h1>
    <p>Upload a file from your browser to Puck.js over Web Bluetooth (Nordic UART Service).</p>
    <input id="file" type="file" />
    <label>Upload filename (on Puck.js Storage): <input id="filename" type="text" placeholder="example.bin" /></label>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button id="connectBtn">Connect to Puck.js</button>
      <button id="uploadBtn" disabled>Upload file to Storage</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <label>Progress:</label>
    <progress id="progress" value="0" max="100"></progress>
    <div id="status" style="margin-top:8px;font-size:0.95rem;color:#333">Idle</div>
    <div class="button-row">
      <a href="javascript:window.history.back();" class="back-button">Back</a>
    </div>
    <h3>Console</h3>
    <pre id="log"></pre>
    <p style="font-size:0.85rem;color:#666">Notes: This page sends Espruino commands to the Puck.js REPL to write the uploaded file into <code>require('Storage')</code>. Data is base64 encoded and written in chunks.</p>

  </div>

<script>
const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_TX_CHAR    = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX_CHAR    = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const progressEl = document.getElementById('progress');
const connectBtn = document.getElementById('connectBtn');
const uploadBtn = document.getElementById('uploadBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const fileInput = document.getElementById('file');
const filenameInput = document.getElementById('filename');
const CHUNKSIZE = 384;// or any multiple of 96 for atob/btoa

let device, server, nusService, txChar, rxChar;

function log(...args){
  console.log(...args);
  logEl.textContent += args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ') + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s){ statusEl.textContent = s; }

async function connect(){
  try{
    log('Requesting Bluetooth device...');
    device = await navigator.bluetooth.requestDevice({
      filters: [{namePrefix: 'Puck'}, {services: [NUS_SERVICE_UUID]}],
      optionalServices: [NUS_SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDisconnected);
    log('Connecting to GATT...');
    server = await device.gatt.connect();
    log('Getting service...');
    nusService = await server.getPrimaryService(NUS_SERVICE_UUID);
    txChar = await nusService.getCharacteristic(NUS_TX_CHAR);
    try{ rxChar = await nusService.getCharacteristic(NUS_RX_CHAR); }
    catch(e){ rxChar = null; log('No RX characteristic (notifications) available.'); }

    if(rxChar){
//      await rxChar.startNotifications();
//      rxChar.addEventListener('characteristicvaluechanged', handleNotification);
    }

    setStatus('Connected to ' + (device.name || device.id));
    uploadBtn.disabled = false;
    disconnectBtn.disabled = false;
    connectBtn.disabled = true;
    log('Ready.');
  }catch(err){ log('Connection failed:', err); setStatus('Connection failed: ' + err); }
}

function onDisconnected(){
  log('Device disconnected');
  setStatus('Disconnected');
  uploadBtn.disabled = true;
  disconnectBtn.disabled = true;
  connectBtn.disabled = false;
}

async function disconnect(){ if(device && device.gatt.connected) await device.gatt.disconnect(); }

function handleNotification(e){
  const value = e.target.value;
  let str = '';
  try{
    for(let i=0;i<value.byteLength;i++){
      const b = value.getUint8(i);
      if(b>=32 && b<=126) str += String.fromCharCode(b); else str += '\\x' + b.toString(16).padStart(2,'0');
    }
  }catch(e){ str = '<unparseable>' }
  //log('RX:', str);
}
  function stringToArrayBuffer(str) {
    var buf=new Uint8Array(str.length);
    for (var i=0; i<str.length; i++) {
      var ch = str.charCodeAt(i);
      if (ch>=256) {
        console.warn("stringToArrayBuffer got non-8 bit character - code "+ch);
        ch = "?".charCodeAt(0);
      }
      buf[i] = ch;
    }
    return buf.buffer;
  }

async function writeCommand(cmd){
  if(!txChar) throw new Error('No TX characteristic');
//  const data = new TextEncoder().encode(cmd + "\n");
//console.log("WRITE: " + data);
  await txChar.writeValue(stringToArrayBuffer(cmd));
}

function arrayBufferToBase64(buffer){
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunkSize = 0x8000;
  for(let i=0;i<bytes.length;i+=chunkSize){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunkSize));
  }
  return btoa(binary);
}

/**
   * Get the JS needed to upload a file
   * @param {string} fileName Path to file to upload
   * @param {string} contents Contents of the file being uploaded
   * @returns {string} JS code needed to upload file
   */
  function getUploadFileCode(fileName, contents) {
    var js = [];
    if (fileName.length==0 || fileName.length>28) {
      throw new Error("Invalid filename length");
    }
    var fn = JSON.stringify(fileName);
    let chunckSize = 0;
    let arrayPos = 0;
    if(contents.length < CHUNKSIZE) {
        chunckSize = contents.length;
    }
    else {
        chunckSize = CHUNKSIZE
    }
    console.log("LEN: " + contents.length + " : " + chunckSize);
    for (var i=0;i<contents.length;i+=chunckSize) {
      let part = new Uint8Array(chunckSize);
      for(j=0; j<part.length; j++) {
          part[j] = contents[i+j];
      }
        console.log("PART1: " + part);
      if((contents.length - i) < CHUNKSIZE) {
        chunckSize = contents.length - i;
      }
      else {
        chunckSize = CHUNKSIZE;
      }
      console.log("PART2: " + part);
      let jsstr = `require("Storage").write(${fn},atob(${JSON.stringify(part.toBase64())}),${i}${(i==0)?","+contents.length:""})`
    console.log("JSSTR: " + jsstr);
      js.push(jsstr);
    }
    return js.join("\n");
  }


async function upload(){
  const file = fileInput.files[0];
  if(!file){ alert('Select a file first'); return; }
  if(!filenameInput.value.trim()){
    filenameInput.value = file.name; // default to selected filename
  }
  const filename = filenameInput.value.trim();

  setStatus('Reading file...');
  const buf = await file.arrayBuffer();
  const view = new Uint8Array(buf);
    console.log("VIEW LEN: " + view.length);

  let js = getUploadFileCode(filename, view); //.replace(/\n/g,"\n\x10");
  console.log("JS: " + js.length);

  setStatus('Uploading file');

  for(let i=0;i<js.length;i++){
    const cmd = js[i];
    //console.log("JSCMD: " + cmd);
    //await writeCommand(cmd);
    progressEl.value = ((i+1)*100)/js.length;
    await new Promise(r=>setTimeout(r,30));
  }

  setStatus('Upload complete');
  log('Upload finished. Sent', buf.byteLength, 'bytes');
}

connectBtn.addEventListener('click', connect);
uploadBtn.addEventListener('click', upload);
disconnectBtn.addEventListener('click', disconnect);

fileInput.addEventListener('change', ()=>{
  if(fileInput.files.length){
    filenameInput.value = fileInput.files[0].name;
  }
});

if(!navigator.bluetooth){
  setStatus('Web Bluetooth API not available in this browser. Use Chrome/Edge on Desktop or Android.');
}
</script>
</body>
</html>
